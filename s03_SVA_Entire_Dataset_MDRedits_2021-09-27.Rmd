---
title: "SVA on Entire Dataset"
output:
  html_document:
    df_print: paged
---

# Load Necessary Packages
```{r message=FALSE}
# install.packages("BiocManager")
# library(BiocManager)
# BiocManager::install("sva") # install sva package
# BiocManager::install("limma") # install limma package
# install.packages("tidyverse")
# install.packages("data.table")
rm(list = ls())
library(sva)
library(limma)
library(tidyverse)
library(data.table)
library(MASS)
library(car)
library(lme4)
library(parallel)
```

# Load Datasets, curate bad labels
```{r}
# set working directory for easy access of data
notebookDirectory = getwd()
setwd("../raw_data") 

# read in expression data
mdata <- data.frame(fread("Orthogroup_RNAseq_8-23-21.csv", header=T))
rownames(mdata) <- mdata$Orthogroups # Reset row names to orthogroup names, needed for SVA
mdata = mdata[,which(colnames(mdata) != "Orthogroups")]

# read in phenotype data
pheno <- read.csv("metadata_labels.csv", header=T) 

#Check for duplicates
any(duplicated(pheno$sra))
pheno$sra[duplicated(pheno$sra)]
pheno[which(pheno$sra == "SRR4450257"),]
pheno[grepl("M_polymorpha_",pheno$NEW_sample_id),]
pheno = pheno[which(!duplicated(pheno$sra)),] # remove duplicate for now

#Extract species
pheno$species = gsub("_[0-9]{1,3}", "", pheno$NEW_sample_id)
unique(pheno$species)

# look at the number of samples in each factor
table(pheno$NEW_tissue) ; table(pheno$NEW_stress) ; table(pheno$NEW_family)

# read in Bioproject ID information that corresponds to pheno2
setwd(notebookDirectory)
bioproject <- read.delim("bioproject_ids.txt", header=F, sep=",")
colnames(bioproject) <- c("sra", "bioproject") # rename columns

# Remove outliers
outliers = read.csv("SRRs_to_exclude.csv", header = F)$V1
pheno = pheno[which(!(pheno$sra %in% outliers)),]
mdata = mdata[,which(!(colnames(mdata) %in% outliers))]

#Summarize phenotype matrices
table(pheno$NEW_family)
table(pheno$NEW_tissue)
table(pheno$NEW_stress)

# Collapse tissue categories
pheno$NEW_NEW_tissue = pheno$NEW_tissue

pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "early_inflorescence")] = "flower"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "emerging_inflorescence")] = "flower"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "inflorescence")] = "flower"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "anther")] = "flower"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "pistil")] = "flower"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "flowers")] = "flower"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "inflorescence1cm")] = "flower"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "inflorescence5cm")] = "flower"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "inflorescence5mm")] = "flower"

pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "fruits")] = "fruit"

pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "Leaf")] = "leaf"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "leaves")] = "leaf"

pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "Root")] = "root"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "roots")] = "root"

pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "embryo")] = "seed"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "endosperm")] = "seed"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "germinating_embryo")] = "seed"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "grain")] = "seed"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "grain15dpa")] = "seed"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "grain5dpa")] = "seed"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "seed_10dap")] = "seed"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "seed_5dap")] = "seed"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "seed10dap")] = "seed"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "seed5dap")] = "seed"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "seeds")] = "seed"

pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "whole_seedling")] = "seedling"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "whole seedling")] = "seedling"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "cotyledon")] = "seedling"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "cotyledon_120_hour")] = "seedling"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "cotyledon_24_hour")] = "seedling"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "cotyledon_48_hour")] = "seedling"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "cotyledon_72_hour")] = "seedling"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "cotyledon_96_hour")] = "seedling"

pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "tiller")] = "stem"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "shoot")] = "stem"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "meristem")] = "stem"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "Stem")] = "stem"

pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "stem+leaf")] = "other"
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "N/A")] = "other" # double-check these later
pheno$NEW_NEW_tissue[which(pheno$NEW_NEW_tissue == "")] = "other" # double-check these later

# Collapse stress categories
pheno$NEW_NEW_stress = pheno$NEW_stress
pheno$NEW_NEW_stress[which(pheno$NEW_NEW_stress == "Drought")] = "drought"
pheno$NEW_NEW_stress[which(pheno$NEW_NEW_stress == "Healthy")] = "healthy"
pheno$NEW_NEW_stress[which(pheno$NEW_NEW_stress == "phosphorous")] = "phosphorus"
pheno$NEW_NEW_stress[which(pheno$NEW_NEW_stress == "Salt")] = "salt"
pheno$NEW_NEW_stress[which(pheno$NEW_NEW_stress == "orther")] = "other"

#Summarize phenotype matrices
table(pheno$NEW_NEW_tissue)
table(pheno$NEW_NEW_stress)

# combine bioproject and pheno
pheno <- left_join(pheno, bioproject, by="sra") # combine by matching sra columns
#write.csv(pheno, "pheno_data.csv")

# visualize expression and phenotype data
head(mdata[,1:5]) ; head(pheno)

#Compare new and old labels
pheno[which(pheno$NEW_NEW_tissue != pheno$NEW_tissue),c("NEW_NEW_tissue", "NEW_tissue")]
#pheno[,c("NEW_NEW_tissue", "NEW_tissue")]

#Write phenotype matrix 
write.csv(pheno, "metadata_labels_collapsedFactorLevels_2021-09-27.csv", row.names = F, quote = F)
```

# Prep metadata for SVA
```{r}
# remove SRA accessions in pheno data that do not have expression data
rownames(pheno) = pheno$sra
pheno2 <- pheno[(rownames(pheno) %in% colnames(mdata)),] # SRAs in pheno that match mdata
pheno2$sample <- 1:nrow(pheno2) # create a sample column
rownames(pheno2) <- pheno2$sra # reset rownames to SRA accessions

#Subset only needed data
pheno2 = pheno2[,c("sra", "NEW_sample_id", "NEW_family", "NEW_NEW_tissue", "NEW_NEW_stress", "bioproject", "species", "sample")]
names(pheno2) = c("sra", "sample_id", "family", "tissue", "stress", "bioproject", "species", "sample")

#Summarize phenotype matrices
table(pheno2$family)
table(pheno2$tissue)
table(pheno2$stress)
```

# Set Full and Null Models
```{r}
# full model matrix - family, stress, tissue should be sig
mod <- model.matrix(~stress+tissue+family, data=pheno2)
mod_no_fam <- model.matrix(~stress+tissue, data=pheno2)
mod_no_tis <- model.matrix(~stress+family, data=pheno2)
mod_no_fam_tis <- model.matrix(~stress, data=pheno2)

# null model matrix (no adjustment variables are included)
null_mod <- model.matrix(~1, data=pheno2)

# expression data must be a matrix
mdata <- as.matrix(mdata)
#mdataNorm = as.matrix(mdataNorm)
```

# Perform SVASeq on Entire Dataset
```{r}

# Estimate surrogate variables (SVs) using the two-step SVA method
# svaseq applies a log(data+1) transformation to the input data
myfunc <- function(args) {
  library(sva)
	svaseq(mdata, args, null_mod, method = "two-step", n.sv=35)
}
clust <- makeCluster(4) # set up cluster for parallel processing
args <- list(mod, mod_no_fam, mod_no_tis, mod_no_fam_tis) # arguments for sva analysis
clusterExport(clust,list('myfunc','mdata', 'null_mod'))
out <- parLapply(clust, args, myfunc) # execute sva in parallel
stopCluster(clust) # close the cluster
SVs <- out[[1]]$sv # 23 SVs
SVs_no_fam <- out[[2]]$sv # 30 SVs
SVs_no_tis <- out[[3]]$sv # 24 SVs
SVs_no_fam_tis <- out[[4]]$sv # 33 SVs
# plot of first 2 surrogate variables
plot(SVs, pch=20, col="blue")
plot(SVs_no_fam, pch=20, col="blue")
plot(SVs_no_tis, pch=20, col="blue")
plot(SVs_no_fam_tis, pch=20, col="blue")
# Save SVs to file:
rownames(SVs) <- colnames(mdata)
write.csv(SVs, "SVs_Orthogroup_RNAseq_8-23-21.csv")
rownames(SVs_no_fam) <- colnames(mdata)
write.csv(SVs_no_fam, "SVs_no_fam_Orthogroup_RNAseq_8-23-21.csv")
rownames(SVs_no_tis) <- colnames(mdata)
write.csv(SVs_no_tis, "SVs_no_tissue_Orthogroup_RNAseq_8-23-21.csv")
rownames(SVs_no_fam_tis) <- colnames(mdata)
write.csv(SVs_no_fam_tis, "SVs_no_family_tissue_Orthogroup_RNAseq_8-23-21.csv")
```

# PCA
```{r}
## Generate a clean matrix using a function by Andrew Jaffe
# This function removes the effects of SVs from our expression data
#'y' as the gene expresion matrix
#'mod' as the model matrix you sent to sva (the full model)
#'svs' as svobj$sv where svobj is the output from the sva function
cleanY = function(y, mod, svs) {
    X = cbind(mod, svs) # same as modSv
    Hat = solve(t(X) %*% X) %*% t(X)
    beta = (Hat %*% t(y))
    rm(Hat)
    gc()
    P = ncol(mod)
    return(y - t(as.matrix(X[,-c(1:P)]) %*% beta[-c(1:P),]))
}

#Remove effects of svs
clean_data_svs <- cleanY(mdata, mod, SVs)

#Remove effects of svs and family
clean_data_noFam <- cleanY(mdata, mod_no_fam, SVs_no_fam)

#Remove effects of svs and tissue
clean_data_noTis <- cleanY(mdata, mod_no_tis, SVs_no_tis)

#Remove effects of svs and family and tissue
clean_data_noFamTis = cleanY(mdata, mod_no_fam_tis, SVs_no_fam_tis)

# Function for plotting pca
plot_pca <- function(Legend, title){
  x %>% as.data.frame %>%
  ggplot(aes(x=PC1,y=PC2, col=Legend)) + geom_point() + 
  ggtitle(title) +
  labs(x=paste("PC1: ",round(var_explained[1]*100,2),"%"),
       y=paste("PC2: ",round(var_explained[2]*100,2),"%"))
}

# Plot PCA of cleaned matrix
pca.res <- prcomp(t(clean_data_svs), center = T, scale = T) # run PCA
pca.res$x[1:5,1:5] # visualize matrix of principle components (PCs)
var_explained <- pca.res$sdev^2/sum(pca.res$sdev^2) # explained variance for each PC
var_explained[1:5] # visualize matrix of explained variance per PC
x <- data.frame(pca.res$x) # create a dataframe of PCs
plot_pca(pheno2$stress, "PCA on Clean Data (Stress)")
plot_pca(pheno2$tissue, "PCA on Clean Data (Tissue)")
plot_pca(pheno2$family, "PCA on Clean Data (Family)")

# write cleaned data to file
write.csv(clean_data_svs, "clean_Orthogroup_RNAseq_onlySVsCorrected_9-27-21.csv", row.names = F, quote = F)
write.csv(clean_data_noFam, "clean_Orthogroup_RNAseq_FamilyCorrected_9-27-21.csv", row.names = F, quote = F)
write.csv(clean_data_noTis, "clean_Orthogroup_RNAseq_TissueCorrected_9-27-21.csv", row.names = F, quote = F)
write.csv(clean_data_noFamTis, "clean_Orthogroup_RNAseq_FamilyAndTissueCorrected_9-71-21.csv", row.names = F, quote = F)

# Check data matches results from Kenia
clean_data_svs[1:5,1:5]
clean_data_noFam[1:5,1:5]
clean_data_noTis[1:5,1:5]
clean_data_noFamTis[1:5,1:5]
```

# Calculate variance explained by SVs
```{r}
#Add surrogate variables to model matrix
modSv = cbind(mod,SVs)
fitSv = lmFit(mdata,modSv)
fitNoSv = lmFit(mdata,mod)
summary(fitNoSv)
summary(fitSv)

#Get fitted values to calculated residual variance
fittedValuesNoSv = fitted.values(fitNoSv)
fittedValuesSv = fitted.values(fitSv)

#Residual/error variance
resVarNoSV = rowSums((mdata - fittedValuesNoSv)^2)
resVarSv = rowSums((mdata - fittedValuesSv)^2)

#Total variance
calcTotalVar = function(x){
  sum((x - mean(x))^2)
}
totalVar = apply(mdata, MARGIN = 1, FUN = calcTotalVar)

#Proportion of variance explained (1 - unexplained variance)
explainVarNoSv = 1 - (resVarNoSV/totalVar)
explainVarSv = 1 - (resVarSv/totalVar)

#Calculate adjusted R^2
#Because the model with Svs has more predictors, it is guaranteed to always explain more variance than a model without SVs regardless of how much extra information SVs provide to the model
n = ncol(mdata) # number of datapoints
kSv = ncol(modSv) # number of predictors for model with SVs
kNoSv = ncol(mod) # number of predictors for model without SVs

adjExplainedVarNoSV = 1 - ((1 - explainVarNoSv)*(n - 1))/(n - kNoSv - 1)
adjExplainedVarSV = 1 - ((1 - explainVarSv)*(n - 1))/(n - kSv - 1)

#How much extra variance is explained when SVs are added?
diffVarExplained = explainVarSv - explainVarNoSv
adjDiffVarExplained = adjExplainedVarSV - adjExplainedVarNoSV

#Summarize results
hist(diffVarExplained, main = "Histogram of variance explained by SVs", ylab = "Number of orthogroups", xlab = "Proportion of variance explained by SVs")
hist(adjDiffVarExplained, main = "Histogram of variance explained by SVs", ylab = "Number of orthogroups", xlab = "Difference in adjusted R^2 for models with and without SVs")

summary(diffVarExplained)
summary(adjDiffVarExplained)
```

# Adjusting for SVs using `f.pvalue` Method from SVA Package
```{r}
# The f.pvalue function can be used to calculate parametric F-test p-values for each row of a data matrix
# The F-test compares the models mod and null_mod. They must be nested models, so all of the variables in null_mod must appear in mod.

# Calculate the F-test p-values for differential expression without adjusting for surrogate variables
pValues = f.pvalue(mdata,mod,null_mod)
qValues = p.adjust(pValues,method="BH")
head(pValues) ; head(qValues)

# Include the surrogate variables in both the null and full models to adjust for the surrogate variables by treating them as adjustment variables that must be included in both models. 
mod0Sv = cbind(null_mod,SVs)
pValuesSv = f.pvalue(mdata,modSv,mod0Sv)
qValuesSv = p.adjust(pValuesSv,method="BH")
head(pValuesSv) ; head(qValuesSv)

# Identify orthogroups (OGs) that are NOT differentially expressed with respect to stress + tissue + family
length(qValuesSv[qValuesSv>0.05]) # 1 w/BH corrected p-value > 0.05
qValuesSv[qValuesSv>0.05] # corresponding OGs
```

# Correlation between SVs and Sample, Species, & BioProject
```{r}
# Multiple linear regression for testing the association between SVs and 3 batch variables: bioproject, sample, and species
test <- lm(SVs ~ bioproject + sample + species, data = pheno2)
summary(test)

# Simple Linear Regression to test the association between bioproject and SVs
test2 <- lm(SVs~bioproject, data = pheno2) ; summary(test2)

# Simple Linear Regression to test the association between sample and SVs
test3 <- lm(SVs~sample, data = pheno2) ; summary(test3)

# Simple Linear Regression to test the association between species and SVs
test4 <- lm(SVs~species, data = pheno2) ; summary(test4)
```
BioProject and Species are colinear due to each bioproject corresponding to a single species. No batch correction by BioProject will be performed since it is highly correlated with the surrogate variables.

